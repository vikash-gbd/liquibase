      - name: Deploy to Snowflake
        env:
          SF_ACCOUNT:   ${{ secrets.SF_ACCOUNT }}
          SF_DATABASE:  ${{ secrets.SF_DATABASE }}
          SF_SCHEMA:    ${{ secrets.SF_SCHEMA }}
          SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SF_ROLE:      ${{ secrets.SF_ROLE }}
          SF_USER:      ${{ secrets.SF_USER }}
          SF_PASSWORD:  ${{ secrets.SF_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”§ Starting deployment"

          URL="jdbc:snowflake://${SF_ACCOUNT}.snowflakecomputing.com/?warehouse=${SF_WAREHOUSE}&role=${SF_ROLE}"

          mkdir -p .first_run_done 2>/dev/null || true

          files_to_update=()

          while IFS= read -r sql_file; do
            marker_file=".first_run_done/${sql_file}.done"
            if [ ! -f "$marker_file" ]; then
              echo "ðŸ§ª First run for $sql_file â€“ performing dry run + changelogSync"

              liquibase-cli/liquibase \
                --url="$URL" \
                --username="$SF_USER" \
                --password="$SF_PASSWORD" \
                --changelog-file=liquibase/changelog/liquibase-master.xml \
                --driver=net.snowflake.client.jdbc.SnowflakeDriver \
                updateSql > dry-run-${sql_file//\//_}.sql

              liquibase-cli/liquibase \
                --url="$URL" \
                --username="$SF_USER" \
                --password="$SF_PASSWORD" \
                --changelog-file=liquibase/changelog/liquibase-master.xml \
                --driver=net.snowflake.client.jdbc.SnowflakeDriver \
                changelogSync

              touch "$marker_file"
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add "$marker_file"
              git commit -m "chore: mark $sql_file as dry-run completed"
              git push origin main

              echo "âœ… Dry run + changelogSync done for $sql_file. Exiting."
              exit 0
            else
              files_to_update+=("$sql_file")
            fi
          done < <(find ddl -name "*.sql" | sort)

          echo "ðŸ§¹ Clearing checksums"
          liquibase-cli/liquibase \
            --url="$URL" \
            --username="$SF_USER" \
            --password="$SF_PASSWORD" \
            --changelog-file=liquibase/changelog/liquibase-master.xml \
            --driver=net.snowflake.client.jdbc.SnowflakeDriver \
            clearCheckSums

          echo "ðŸš€ Applying real update"
          liquibase-cli/liquibase \
            --url="$URL" \
            --username="$SF_USER" \
            --password="$SF_PASSWORD" \
            --changelog-file=liquibase/changelog/liquibase-master.xml \
            --driver=net.snowflake.client.jdbc.SnowflakeDriver \
            update
