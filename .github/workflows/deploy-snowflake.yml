name: Deploy to Snowflake

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
      SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
      SF_USER: ${{ secrets.SF_USER }}
      SF_PASSWORD: ${{ secrets.SF_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download Liquibase CLI
        run: |
          curl -sL https://github.com/liquibase/liquibase/releases/download/v4.24.0/liquibase-4.24.0.tar.gz -o liquibase.tar.gz
          mkdir -p liquibase-cli
          tar -xzf liquibase.tar.gz -C liquibase-cli --strip-components=1
          rm liquibase.tar.gz

      - name: Run Liquibase Dry Run + changelogSync (First Run)
        run: |
          echo "üîß Starting deployment"
          URL_BASE="jdbc:snowflake://${SF_ACCOUNT}.snowflakecomputing.com"

          found_first_run=0

          for sql in ddl/*/*/table/*.sql; do
            database=$(echo "$sql" | cut -d'/' -f2)
            schema=$(echo "$sql" | cut -d'/' -f3)
            base_sql=$(basename "$sql")
            marker="ddl/$database/$schema/table/.first_run_done/${base_sql}.done"

            mkdir -p "ddl/$database/$schema/table/.first_run_done"

            if [ ! -f "$marker" ]; then
              echo "üß™ Dry-run: $sql | DB: $database | Schema: $schema"

              liquibase-cli/liquibase \
                --url="${URL_BASE}/?warehouse=${SF_WAREHOUSE}&db=${database}&schema=${schema}" \
                --username="$SF_USER" \
                --password="$SF_PASSWORD" \
                --changelog-file=liquibase/changelog/liquibase-master.xml \
                --driver=net.snowflake.client.jdbc.SnowflakeDriver \
                updateSql > dryrun-${base_sql}.sql

              liquibase-cli/liquibase \
                --url="${URL_BASE}/?warehouse=${SF_WAREHOUSE}&db=${database}&schema=${schema}" \
                --username="$SF_USER" \
                --password="$SF_PASSWORD" \
                --changelog-file=liquibase/changelog/liquibase-master.xml \
                --driver=net.snowflake.client.jdbc.SnowflakeDriver \
                changelogSync

              touch "$marker"
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add "$marker"
              git commit -m "‚úÖ Dry‚Äërun done for $base_sql"
              git push origin main

              echo "‚úÖ Dry‚Äërun complete for $base_sql"
              found_first_run=1
            else
              echo "‚ö†Ô∏è Already processed: $sql"
            fi
          done

          if [ "$found_first_run" -eq 1 ]; then
            echo "‚úÖ One or more dry-runs executed. Skipping full update."
            exit 0
          fi

      - name: Run Full Deployment (Liquibase update)
        run: |
          echo "üßπ All dry-runs done ‚úîÔ∏é Running real deployment now"
          URL="jdbc:snowflake://${SF_ACCOUNT}.snowflakecomputing.com/?warehouse=${SF_WAREHOUSE}"

          liquibase-cli/liquibase \
            --url="$URL" \
            --username="$SF_USER" \
            --password="$SF_PASSWORD" \
            --changelog-file=liquibase/changelog/liquibase-master.xml \
            --driver=net.snowflake.client.jdbc.SnowflakeDriver \
            clearCheckSums

          liquibase-cli/liquibase \
            --url="$URL" \
            --username="$SF_USER" \
            --password="$SF_PASSWORD" \
            --changelog-file=liquibase/changelog/liquibase-master.xml \
            --driver=net.snowflake.client.jdbc.SnowflakeDriver \
            update
