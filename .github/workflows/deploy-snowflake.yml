name: Deploy to Snowflake (Per Table Dry Run + Sync)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      LIQUIBASE_PROPS_FILE: ./liquibase.properties
      SNOWFLAKE_USERNAME: ${{ secrets.SNOWFLAKE_USERNAME }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}

    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v3

      - name: ‚òï Set up Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: üì• Download and Set Up Liquibase CLI
        run: |
          curl -sL https://github.com/liquibase/liquibase/releases/download/v4.24.0/liquibase-4.24.0.zip -o liquibase.zip
          unzip -q liquibase.zip -d liquibase-cli
          chmod +x liquibase-cli/liquibase

      - name: ‚ûï Add Liquibase to PATH
        run: echo "${{ github.workspace }}/liquibase-cli" >> $GITHUB_PATH

      - name: üß™ Verify Liquibase Installation
        run: liquibase --version

      - name: üß© Run Liquibase Per-SQL Dry Run and Sync (with .done flag)
        run: |
          mkdir -p liquibase/tmp
          find ddl -type f -name "*.sql" | while read sql_file; do
            done_flag="${sql_file}.done"
            if [ ! -f "$done_flag" ]; then
              echo "üìÑ Processing $sql_file"

              changelog_path="liquibase/tmp/single-temp.xml"
              echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" > $changelog_path
              echo "<databaseChangeLog" >> $changelog_path
              echo "  xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog\"" >> $changelog_path
              echo "  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"" >> $changelog_path
              echo "  xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog" >> $changelog_path
              echo "  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd\">" >> $changelog_path
              echo "  <changeSet id=\"$(date +%s)-$RANDOM\" author=\"auto\">" >> $changelog_path
              echo "    <sqlFile path=\"$sql_file\" relativeToChangelogFile=\"false\" splitStatements=\"true\" stripComments=\"true\"/>" >> $changelog_path
              echo "  </changeSet>" >> $changelog_path
              echo "</databaseChangeLog>" >> $changelog_path

              liquibase --changeLogFile=$changelog_path --defaultsFile=liquibase.properties updateSql
              liquibase --changeLogFile=$changelog_path --defaultsFile=liquibase.properties changelogSync

              touch "$done_flag"
              echo "‚úÖ Done: $sql_file"
            else
              echo "‚è≠Ô∏è  Skipping (already done): $sql_file"
            fi
          done
